# Net Operating Income (NOI) Calculation Methodology

## Table of Contents
1. [Overview](#overview)
2. [Acronym Glossary](#acronym-glossary)
3. [Building Type Classification](#building-type-classification)
4. [Data Sources](#data-sources)
5. [Calculation Methods](#calculation-methods)
6. [Static Rate Disclaimers](#static-rate-disclaimers)
7. [Error Handling](#error-handling)
8. [API Integration](#api-integration)

## Overview

This document explains the methodology used to calculate **Net Operating Income (NOI)** for New York City residential buildings. NOI represents the annual income generated by a property after deducting all operating expenses but before deducting taxes and debt service.

The calculation method varies based on building ownership type:
- **Cooperative (Co-op) Buildings**: Direct API lookup from NYC Open Data
- **Condominium (Condo) Buildings**: Direct API lookup from NYC Open Data  
- **Rental Buildings**: Calculated using static rates from NYC Rent Guidelines Board data

## Acronym Glossary

| Acronym | Full Name | Definition |
|---------|-----------|------------|
| **NOI** | Net Operating Income | Annual income after operating expenses, before taxes and debt service |
| **BBL** | Building Block and Lot | NYC's unique 10-digit property identifier |
| **PLUTO** | Primary Land Use Tax Lot Output | NYC's comprehensive property database |
| **LL84** | Local Law 84 | NYC energy benchmarking law requiring emissions reporting |
| **RPIE** | Real Property Income and Expense | NYC property financial reporting system |
| **EFLH** | Equivalent Full Load Hours | Energy calculation metric for heating systems |
| **Co-op** | Cooperative | Building owned collectively by shareholders |
| **Condo** | Condominium | Individual units owned separately with shared common areas |
| **DOF** | Department of Finance | NYC agency managing property assessments |
| **API** | Application Programming Interface | System for accessing data programmatically |

## Building Type Classification

### NYC Building Class Code System

The system uses NYC Department of Finance building class codes to determine building type:

#### Cooperative Buildings (Co-ops)
- **Building Classes**: C0, C1, C2, C3, C4, C5, C6, C7, C8, C9
- **Definition**: Buildings owned collectively by a corporation where residents own shares
- **NOI Source**: NYC Open Data Cooperative Comparable Rental Income dataset

#### Condominium Buildings (Condos)  
- **Building Classes**: R4, R5, R6A, R6B, R7A, R7B, R8A, R8B, R9A, R9B, D4, D5, D6, D7, D8, D9
- **Definition**: Buildings where individual units are owned separately
- **NOI Source**: NYC Open Data Condominium Comparable Rental Income dataset

#### Rental Buildings
- **Building Classes**: All other residential codes (R1, R2, R3, R6, R7, R8, R9 non-condominium variants)
- **Definition**: Buildings where units are rented to tenants
- **NOI Source**: Calculated using static rates from NYC Rent Guidelines Board

## Data Sources

### Primary Sources

1. **NYC Open Data - Cooperative Comparable Rental Income**
   - **URL**: https://data.cityofnewyork.us/City-Government/DOF-Cooperative-Comparable-Rental-Income-Citywide-/myei-c3fa/about_data
   - **API Field**: `net_operating_income`
   - **Usage**: Direct NOI values for cooperative buildings

2. **NYC Open Data - Condominium Comparable Rental Income**
   - **URL**: https://data.cityofnewyork.us/City-Government/DOF-Condominium-Comparable-Rental-Income-in-NYC/9ck6-2jew/about_data
   - **API Field**: `net_operating_income`
   - **Usage**: Direct NOI values for condominium buildings

3. **NYC Rent Guidelines Board - 2024 Income & Expense Study**
   - **URL**: https://rentguidelinesboard.cityofnewyork.us/wp-content/uploads/2024/03/2024-IE-Study.pdf
   - **Usage**: Borough-specific rental rates and expense ratios for rental building calculations

4. **PLUTO (Primary Land Use Tax Lot Output)**
   - **URL**: https://data.cityofnewyork.us/resource/64uk-42ks.json
   - **Usage**: Building characteristics (square footage, building class, year built, borough)

### Secondary Sources

- **RentHop Average Rent Data**: Market validation (not used in calculations)
- **NYC Department of Finance Building Classifications**: Building class code definitions

## Calculation Methods

### Cooperative and Condominium Buildings

**Method**: Direct API lookup
**Process**:
1. Query NYC Open Data using BBL
2. Extract `net_operating_income` field
3. Return most recent year's data
4. Validate that NOI value is positive and numeric

**Example Response**:
```json
{
  "bbl": "1012340456",
  "buildingType": "COOPERATIVE", 
  "noiValue": 850000.00,
  "dataSource": "NYC Open Data - Cooperative Comparable Rental Income",
  "calculationMethod": "Direct API value",
  "reportYear": "2023"
}
```

### Rental Buildings

**Method**: Calculated using static rates
**Formula**: `NOI = Total Units × Borough Rate × Age Multiplier × 12 months × 1.108 × 0.45`

#### Step 1: Base Rental Income Calculation
```
Annual Rental Income = Total Units × Rate Per Unit Per Month × 12 months
```

Where **Total Units** comes from existing unit breakdown analysis:
- Studio units
- One-bedroom units  
- Two-bedroom units
- Three-plus-bedroom units

#### Step 2: Borough-Specific Rates

Based on NYC Rent Guidelines Board 2024 Income & Expense Study:

| Borough | Rate Per Unit Per Month | Data Source |
|---------|------------------------|-------------|
| **Manhattan** | $2,498 (average) | RPIE 2024 Study |
| - Core Manhattan | $3,118 | RPIE 2024 Study |
| - Upper Manhattan | $1,649 | RPIE 2024 Study |
| **Brooklyn** | $1,640 | RPIE 2024 Study |
| **Queens** | $1,603 | RPIE 2024 Study |
| **Bronx** | $1,224 | RPIE 2024 Study |
| **Staten Island** | $1,166 | RPIE 2024 Study |

#### Step 3: Building Age Adjustments

Buildings are adjusted based on construction era:

| Construction Period | Rate Multiplier | Calculation Basis |
|-------------------|-----------------|-------------------|
| **Pre-1974** | 0.897 | $1,587 ÷ $1,769 (citywide average) |
| **Post-1973** | 1.442 | $2,552 ÷ $1,769 (citywide average) |

#### Step 4: Supplemental Income
```
Gross Income = Annual Rental Income × 1.108
```

The **1.108 multiplier (10.8% increase)** accounts for supplemental income sources:
- Laundry facilities
- Parking fees
- Vending machines
- Commercial space rental
- Cell tower leases
- Billboard advertising

*Source: NYC Rent Guidelines Board 2024 study showing 10.8% average supplemental income*

#### Step 5: Operating Expenses and NOI Margin
```
NOI = Gross Income × 0.45
```

The **45% NOI margin** accounts for:
- **Operating Expenses** (25-35% of gross income): Maintenance, utilities, management, insurance
- **Property Taxes** (~25% of gross income): NYC property tax burden
- **Net Operating Income** (45% remaining): Available for debt service and owner returns

#### Complete Rental Calculation Example

**Building**: 50-unit Queens rental building built in 1985
- Units: 10 studios + 15 one-bedrooms + 20 two-bedrooms + 5 three-bedrooms = 50 total
- Borough Rate: $1,603/unit/month (Queens)
- Age Multiplier: 1.442 (Post-1973)
- Adjusted Rate: $1,603 × 1.442 = $2,311/unit/month

```
Annual Rental Income = 50 units × $2,311 × 12 months = $1,386,600
Gross Income = $1,386,600 × 1.108 = $1,536,355
NOI = $1,536,355 × 0.45 = $691,360
```

## Static Rate Disclaimers

### ⚠️ Important Limitations

1. **Static 2024 Data**: Rental calculations use fixed rates from the 2024 NYC Rent Guidelines Board study, not live market data
2. **Borough Averages**: Rates represent borough-wide averages and may not reflect neighborhood-specific variations
3. **Building Age Approximation**: Two-tier age adjustment (pre/post-1974) is simplified compared to actual market dynamics
4. **Unit Mix Assumption**: Assumes all unit types generate equivalent per-unit income
5. **Supplemental Income**: 10.8% multiplier is citywide average; actual supplemental income varies by building type and location

### Data Freshness

- **Cooperative/Condominium Data**: Retrieved from NYC Open Data APIs (updated periodically by NYC DOF)
- **Rental Calculation Rates**: Fixed from 2024 RPIE study (annual updates required)
- **PLUTO Building Data**: Retrieved from current NYC Open Data PLUTO dataset

## Error Handling

The system implements "fail loud" error handling with specific error messages:

### Data Validation Errors
- `BBL must be exactly 10 digits`
- `PLUTO data not found for BBL: {bbl}`
- `Building square footage is missing or zero for BBL {bbl}`
- `Borough information is missing for BBL {bbl}`
- `Year built is missing for BBL {bbl}`

### Calculation Errors  
- `Unit breakdown data required for rental building NOI calculation for BBL: {bbl}`
- `No residential units found in unit breakdown for BBL {bbl}`
- `Unknown borough: {borough} for BBL {bbl}`
- `Invalid cooperative NOI value: {value} for BBL {bbl}`

### API Errors
- `Cooperative NOI data not available for BBL: {bbl}`
- `Condominium NOI data not available for BBL {bbl}`
- `HTTP error! status: {status_code}`

### Missing Data Scenarios

1. **Missing Unit Breakdown**: Rental buildings require unit count data from previous AI analysis
2. **Missing PLUTO Data**: Building characteristics must be available for classification
3. **Missing API Data**: Cooperative/Condominium buildings must have NOI data in NYC datasets
4. **Invalid Building Class**: Building class code must map to known residential categories

## API Integration

### Endpoint Usage
```
GET /api/noi/{bbl}?studioUnits=10&oneBedUnits=15&twoBedUnits=20&threePlusUnits=5
```

### Response Format
```json
{
  "bbl": "4154320789",
  "buildingType": "RENTAL",
  "noiValue": 691360.00,
  "dataSource": "NYC Rent Guidelines Board 2024 Income & Expense Study", 
  "calculationMethod": "Calculated from unit count, borough rates, and building age",
  "rawData": {
    "buildingSquareFeet": 45000,
    "borough": "Queens",
    "yearBuilt": 1985,
    "unitBreakdown": {
      "studio": 10,
      "oneBed": 15, 
      "twoBed": 20,
      "threePlus": 5
    },
    "ratePerUnitPerMonth": 2311.35,
    "ageMultiplier": 1.442,
    "supplementalIncomeMultiplier": 1.108,
    "noiMargin": 0.45,
    "grossIncome": 1536355.20,
    "calculatedNoi": 691360.00
  }
}
```

### Integration with Energy Calculations

The NOI API supports the financial analysis sections in `energy-calculations.tex`:

1. **Section 9: NOI Analysis** - Provides baseline NOI values for upgrade impact calculations
2. **Section 10: Property Value Analysis** - NOI ÷ Cap Rate = Property Value
3. **Financial Modeling** - NOI improvements from energy savings and LL97 fee avoidance

### Required Dependencies

The NOI calculation system requires:
- Unit breakdown data from existing AI-based building analysis
- PLUTO building characteristics 
- NYC Open Data API access
- Error handling for missing or invalid data

This methodology ensures transparent, well-documented NOI calculations with explicit acknowledgment of static rate limitations and comprehensive error handling for production use.