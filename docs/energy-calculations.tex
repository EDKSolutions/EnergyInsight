\documentclass{article}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{geometry}
\usepackage{xcolor}
\usepackage{tikz}
\usepackage{pgfplots} % For creating graphs
\pgfplotsset{compat=1.18}
\usetikzlibrary{shapes.geometric, arrows, positioning}
\usepackage{listings} % For code syntax highlighting
\usepackage{xcolor} % Already included but ensure for listings

% Configure TypeScript syntax highlighting
\lstdefinelanguage{TypeScript}{
  keywords={const, let, var, function, return, if, else, for, while, break, continue, true, false, null, undefined, number, string, boolean, any, void, interface, type, class, extends, implements, public, private, protected, static, readonly, abstract, async, await, import, export, from, as, default},
  keywordstyle=\color{blue}\bfseries,
  ndkeywords={console, log},
  ndkeywordstyle=\color{purple}\bfseries,
  identifierstyle=\color{black},
  sensitive=true,
  comment=[l]{//},
  morecomment=[s]{/*}{*/},
  commentstyle=\color{gray}\ttfamily,
  stringstyle=\color{red}\ttfamily,
  morestring=[b]',
  morestring=[b]",
  morestring=[b]`,
}

\lstset{
  language=TypeScript,
  basicstyle=\ttfamily\footnotesize,
  numbers=left,
  numberstyle=\tiny\color{gray},
  stepnumber=1,
  numbersep=5pt,
  backgroundcolor=\color{gray!5},
  showspaces=false,
  showstringspaces=false,
  showtabs=false,
  frame=single,
  rulecolor=\color{black},
  tabsize=2,
  captionpos=b,
  breaklines=true,
  breakatwhitespace=false,
  escapeinside={\%*}{*\%},
  aboveskip=\bigskipamount,
  belowskip=\bigskipamount
}
\geometry{margin=1in}

% Define a command for code variables
\newcommand{\code}[1]{\textcolor{blue}{\texttt{#1}}}

\title{Energy Calculations for PTAC vs PTHP Systems}
\author{EDK Energy Insight Platform}
\date{\today}

\begin{document}

\maketitle

\tableofcontents
\newpage

\section{Introduction}

This document outlines the energy calculations for comparing Packaged Terminal Air Conditioner (PTAC) and Packaged Terminal Heat Pump (PTHP) systems, using the standardized variable names from our codebase and the AI-determined unit distributions described in the following section.

\section{AI-Powered Unit Distribution Analysis}

Before calculating energy impacts of PTAC to PTHP conversions, we must first determine the unit distribution within each building. Many NYC buildings lack detailed unit mix data, making AI analysis essential for accurate energy modeling.

\subsection{Overview and Purpose}

The EDK platform uses artificial intelligence to analyze building characteristics and determine unit distribution when detailed unit mix data is unavailable. This AI-driven approach processes publicly available building data from NYC agencies to infer the most likely unit breakdown for residential buildings.

\subsection{Input Data Sources}

The AI analysis utilizes two primary data sources:

\subsubsection{PLUTO Data (Primary Input)}

Data from the NYC Department of City Planning's Primary Land Use Tax Lot Output (PLUTO) dataset:

\begin{itemize}
    \item \code{bldgclass}: Building Class Code (e.g., C1, D3, R1, etc.)
    \item \code{yearbuilt}: Year the building was constructed 
    \item \code{unitsres}: Total number of residential units
    \item \code{resarea}: Total residential floor area in square feet
    \item \code{numfloors}: Number of floors in the building
    \item \code{boro}: Borough location (Manhattan, Brooklyn, Queens, Bronx, Staten Island)
\end{itemize}

\subsubsection{Local Law 84 Data (Secondary Input)}

Energy consumption data when available:
\begin{itemize}
    \item \code{site\_eui}: Site Energy Use Intensity
    \item Energy usage patterns and building performance metrics
\end{itemize}

\subsection{AI Analysis Architecture}

The system employs a LangChain-based graph architecture with multiple processing nodes:

\begin{enumerate}
    \item \textbf{Start Node}: Validates input PLUTO data
    \item \textbf{Inference Node}: Uses OpenAI GPT-4 to analyze building characteristics
    \item \textbf{Calculation Node}: Converts unit breakdown to PTAC unit count
    \item \textbf{Validation Node}: Ensures output integrity and constraints
\end{enumerate}

\subsection{Prompt Engineering and Structured Output}

The AI uses carefully crafted prompts with structured output validation to ensure consistent, accurate results:

\begin{lstlisting}
const prompt = `Analyze a building in ${plutoData.boro} with the following 
characteristics and provide a detailed breakdown of residential units:

Building Details:
- Building Class: ${plutoData.bldgclass}
- Year Built: ${plutoData.yearbuilt}
- Total Residential Units: ${plutoData.unitsres}
- Total Residential Area: ${plutoData.resarea} sq ft
- Number of Floors: ${plutoData.numfloors}

Requirements:
1. The sum of all unit types MUST equal exactly ${plutoData.unitsres} total units
2. Consider typical unit layouts and sizes for this building's era and class
3. Account for the total residential area when determining unit mix
4. Consider historical building practices from the construction period

You must return:
1. studio: Number of studio units (must be a non-negative integer)
2. one_bed: Number of one-bedroom units (must be a non-negative integer)  
3. two_bed: Number of two-bedroom units (must be a non-negative integer)
4. three_plus: Number of three or more bedroom units (must be a non-negative integer)
5. reasoning: A detailed explanation of your calculation process`;
\end{lstlisting}

\subsection{Structured Output Schema}

The AI response follows a strict TypeScript schema to ensure data integrity:

\begin{lstlisting}
interface UnitBreakdown {
  studio: number;      // Number of studio units
  one_bed: number;     // Number of one-bedroom units  
  two_bed: number;     // Number of two-bedroom units
  three_plus: number;  // Number of three or more bedroom units
  source: 'AI-Assumed';
}

const unitBreakdownSchema = z.object({
  studio: z.number().int().min(0).describe('Number of studio units'),
  one_bed: z.number().int().min(0).describe('Number of one-bedroom units'),
  two_bed: z.number().int().min(0).describe('Number of two-bedroom units'),
  three_plus: z.number().int().min(0).describe('Number of three or more bedroom units'),
  reasoning: z.string().describe('Detailed explanation of the unit breakdown calculation')
});
\end{lstlisting}

\subsection{Unit Mix to PTAC Unit Calculation}

Once the AI determines the unit breakdown, the system calculates the total number of PTAC units using industry-standard assumptions about air conditioning needs per room:

\subsubsection{PTAC Unit Allocation Rules}

\begin{itemize}
    \item \textbf{Studio Units}: 1 PTAC unit (combined living/sleeping area)
    \item \textbf{One-Bedroom Units}: 2 PTAC units (1 bedroom + 1 living area)
    \item \textbf{Two-Bedroom Units}: 3 PTAC units (2 bedrooms + 1 living area)
    \item \textbf{Three+ Bedroom Units}: 4 PTAC units (3 bedrooms + 1 living area)
\end{itemize}

\subsubsection{PTAC Calculation Formula}

The total building PTAC unit count is calculated as:

\begin{equation}
N_{\text{ptacUnits}} = N_{\text{studio}} \times 1 + N_{\text{oneBed}} \times 2 + N_{\text{twoBed}} \times 3 + N_{\text{threePlus}} \times 4
\end{equation}

Where:
\begin{itemize}
    \item $N_{\text{studio}}$: Number of studio units
    \item $N_{\text{oneBed}}$: Number of one-bedroom units  
    \item $N_{\text{twoBed}}$: Number of two-bedroom units
    \item $N_{\text{threePlus}}$: Number of three or more bedroom units
\end{itemize}

\subsection{Implementation Example}

For a 1960s 6-story building with 24 residential units and 18,000 sq ft of residential area:

\begin{lstlisting}
// AI Analysis Result
{
  "studio": 6,
  "one_bed": 12,
  "two_bed": 6, 
  "three_plus": 0,
  "reasoning": "Based on the building's 1960s construction era and 750 sq ft average unit size, this represents a typical mid-century apartment building layout with a mix of studios and one-bedrooms, plus some larger two-bedroom units for families."
}

// PTAC Unit Calculation  
ptacUnits = 6×1 + 12×2 + 6×3 + 0×4 = 6 + 24 + 18 + 0 = 48 total PTAC units
\end{lstlisting}

\subsection{Validation and Quality Control}

The system implements multiple validation layers:

\begin{enumerate}
    \item \textbf{Sum Validation}: Unit breakdown must equal PLUTO total residential units
    \item \textbf{Non-Zero Check}: Prevents all-zero responses that would indicate analysis failure
    \item \textbf{Integer Validation}: Ensures all unit counts are non-negative integers
    \item \textbf{Reasoning Requirement}: AI must provide detailed explanation for transparency
\end{enumerate}

If validation fails, the system throws an error and requests re-analysis rather than proceeding with invalid data.

\subsection{AI Analysis Output}

The complete AI analysis provides:

\begin{itemize}
    \item Detailed unit breakdown with counts for each unit type
    \item AI reasoning explaining the analysis logic
    \item Total PTAC unit count for energy calculations
    \item Data source attribution (\code{source: 'AI-Assumed'})
    \item Validation confirmation of constraint compliance
\end{itemize}

This AI-generated unit distribution then feeds into all subsequent energy calculations, cost analyses, and LL97 compliance assessments covered in the following sections.

\section{PTAC System Calculations}

\subsection{Per-Unit Constants}

The system uses fundamental constants for PTAC units in original units and their MMBtu equivalents:

\begin{itemize}
    \item \code{annualUnitThermsHeatingPTAC}: 255 therms per year per unit for heating
    \item \code{annualUnitKwhCoolingPTAC}: 16,000 kWh per year per unit for cooling
    \item \code{annualUnitMMBtuHeatingPTAC}: 25.5 MMBtu per year per unit for heating
        \begin{itemize}
            \item Converted from 255 therms × 0.1 MMBtu/therm = 25.5 MMBtu
        \end{itemize}
    \item \code{annualUnitMMBtuCoolingPTAC}: 5.459427 MMBtu per year per unit for cooling
        \begin{itemize}
            \item Converted from 16,000 kWh × 0.003412 MMBtu/kWh = 5.459427 MMBtu
        \end{itemize}
\end{itemize}

\subsection{Building-Level Calculations}

For a building with multiple units, we calculate both MMBtu and original unit values:

\subsubsection{MMBtu Building Totals}
\begin{equation}
\code{annualBuildingMMBtuCoolingPTAC} = N_{ptacUnits} \times \code{annualUnitMMBtuCoolingPTAC}
\end{equation}

\begin{equation}
\code{annualBuildingMMBtuHeatingPTAC} = N_{ptacUnits} \times \code{annualUnitMMBtuHeatingPTAC}
\end{equation}

\begin{equation}
\code{annualBuildingMMBtuTotalPTAC} = \code{annualBuildingMMBtuCoolingPTAC} + \code{annualBuildingMMBtuHeatingPTAC}
\end{equation}


\section{PTHP System Calculations}

\subsection{Heating Energy Conversion with Building-Specific EFLH}

For PTHP systems, the heating energy is calculated using building-specific Equivalent Full Load Hours (EFLH) derived from PLUTO data, combined with PTHP heating capacity and coefficient of performance:

\subsubsection{Step 1: Calculate Annual Building kWh for PTHP Heating}

The annual building heating consumption in kWh is calculated using the detailed equation:

\begin{equation}
\code{annualBuildingkWhHeatingPTHP} = \frac{\code{heatingCapacityPTHP}}{3.412} \times \frac{1}{\code{pthpCOP}} \times \text{EFLH} \times N_{ptacUnits}
\end{equation}

Where:
\begin{itemize}
    \item \code{heatingCapacityPTHP}: 8 KBtu (constant heating capacity per PTHP unit)
    \item 3.412: Conversion factor from KBtu to kW (kW per KBtu)
    \item \code{pthpCOP}: 1.51 (Coefficient of Performance for PTHP)
    \item EFLH: Equivalent Full Load Hours (building-specific, from PLUTO data)
    \item $N_{ptacUnits}$: Number of PTAC units to be replaced
\end{itemize}

\subsubsection{Step 2: EFLH Lookup from PLUTO Data}

The EFLH value is determined by building characteristics from PLUTO data using the following function:

\begin{lstlisting}
export function getEFLHFromPluto(yearBuilt: number, floors: number): number {
  const buildingType = floors <= 6 ? 'lowRise' : 'highRise';
  
  const constructionEra = yearBuilt <= 1939 ? 'prewar' :
                         yearBuilt <= 1978 ? 'pre79' :
                         yearBuilt <= 2006 ? 'post1979' : 'post2007';

  const eflhTable = {
    lowRise: { prewar: 974, pre79: 738, post1979: 705, post2007: 491 },
    highRise: { prewar: 987, pre79: 513, post1979: 385, post2007: 214 }
  };
  
  return eflhTable[buildingType][constructionEra];
}
\end{lstlisting}

The EFLH table categorizes buildings by:
\begin{itemize}
    \item \textbf{Building Type}: Low-rise ($\leq$ 6 floors) vs High-rise (> 6 floors)
    \item \textbf{Construction Era}: Pre-war ($\leq$ 1939), Pre-79 (1940-1978), 1979-2006, 2007-Present
    \item \textbf{EFLH Range}: 214-987 hours depending on building characteristics
\end{itemize}

\subsubsection{Step 3: Convert kWh to MMBtu}

Finally, convert the kWh result to MMBtu for consistency with other calculations:

\begin{equation}
\code{annualBuildingMMBtuHeatingPTHP} = \code{annualBuildingkWhHeatingPTHP} \times 0.003412
\end{equation}

Where 0.003412 is the conversion factor from kWh to MMBtu.

\subsection{Cooling Energy}

The cooling energy for PTHP remains equivalent to PTAC:

\begin{equation}
\code{annualBuildingMMBtuCoolingPTHP} = \code{annualBuildingMMBtuCoolingPTAC}
\end{equation}

\subsection{Total PTHP Energy}

The total annual building energy consumption for PTHP:

\begin{equation}
\code{annualBuildingMMBtuTotalPTHP} = \code{annualBuildingMMBtuCoolingPTHP} + \code{annualBuildingMMBtuHeatingPTHP}
\end{equation}


\section{Energy Reduction Analysis}

The energy reduction achieved by switching from PTAC to PTHP is calculated as:

\begin{equation}
\text{Reduction (\%)} = \frac{\code{annualBuildingMMBtuTotalPTAC} - \code{annualBuildingMMBtuTotalPTHP}}{\code{annualBuildingMMBtuTotalPTAC}} \times 100\%
\end{equation}

\section{Total Retrofit Cost Calculation}

The total cost for retrofitting from PTAC to PTHP systems includes unit costs, installation costs, and contingency:

\begin{equation}
\code{totalRetrofitCost} = (\code{pthpUnitCost} + \code{pthpInstallationCost}) \times \text{Total PTHP Units} \times (1 + \code{pthpContingency})
\end{equation}

Example calculation:
\begin{equation}
\code{totalRetrofitCost} = (\$1,100 + \$450) \times N_{ptacUnits} \times 1.10 = \$1,705 \times N_{ptacUnits}
\end{equation}

Where:
\begin{itemize}
    \item \code{pthpUnitCost}: \$1,100 per PTHP unit
    \item \code{pthpInstallationCost}: \$450 per unit
    \item \code{pthpContingency}: 10\% (1.10 multiplier)
    \item $N_{ptacUnits}$: Total number of PTHP units to be installed
\end{itemize}

\section{Energy Cost Savings Calculation}

To calculate costs, we need building totals in kWh and therms.

\subsection{PTAC Building Totals for Cost Calculations}

\begin{equation}
\code{annualBuildingThermsHeatingPTAC} = N_{ptacUnits} \times \code{annualUnitThermsHeatingPTAC}
\end{equation}

\begin{equation}
\code{annualBuildingKwhCoolingPTAC} = N_{ptacUnits} \times \code{annualUnitKwhCoolingPTAC}
\end{equation}

Where \code{annualUnitKwhCoolingPTAC} = 16,000 kWh per unit per year.

\subsection{PTHP Building Totals for Cost Calculations}

For PTHP systems, the kWh values needed for cost calculations are:

\begin{itemize}
    \item \code{annualBuildingkWhHeatingPTHP}: Already calculated in Section 4.1.1 using EFLH methodology
    \item \code{annualBuildingKwhCoolingPTHP}: Same as PTAC cooling (PTHP cooling efficiency assumed equivalent)
\end{itemize}

\begin{equation}
\code{annualBuildingKwhCoolingPTHP} = \code{annualBuildingKwhCoolingPTAC} = N_{ptacUnits} \times 16,000
\end{equation}

\subsection{Cost Calculations}

The annual energy cost savings from switching to PTHP systems is calculated as:

\begin{align}
\code{annualBuildingCostPTAC} &= \code{annualBuildingKwhCoolingPTAC} \times \code{priceKwhHour} \nonumber \\
&\quad + \code{annualBuildingThermsHeatingPTAC} \times \code{priceThermHour}
\end{align}

\begin{align}
\code{annualBuildingCostPTHP} &= \code{annualBuildingKwhHeatingPTHP} \times \code{priceKwhHour} \nonumber \\
&\quad + \code{annualBuildingKwhCoolingPTHP} \times \code{priceKwhHour}
\end{align}

\begin{align}
\code{annualSavingsEnergy} &= \code{annualBuildingCostPTAC} - \code{annualBuildingCostPTHP}
\end{align}

Where:
\begin{itemize}
    \item \code{priceKwhHour}: \$0.24 per kilowatt-hour for electricity (NYC average)
    \item \code{priceThermHour}: \$1.45 per therm for natural gas (NYC average)\footnote{Heating oil is priced at \$2.60-\$2.77 per therm, but most buildings use natural gas.}
\end{itemize}

\section{LL97 Emissions Savings and Annual Fee Calculation}

\vspace{0.3cm}
\noindent\fbox{%
\parbox{\dimexpr\linewidth-2\fboxsep-2\fboxrule}%
{\textbf{Important Timing Note:} LL97 penalties are not assessed until 2026. Buildings completing upgrades in 2024 or 2025 will not face penalties during the upgrade year. Energy savings and LL97 fee avoidance calculations only apply from 2026 onwards.}%
}
\vspace{0.3cm}

\subsection{Current Building Emissions and Budget}

The building's current emissions are obtained from LL84 reporting, specifically from the \code{total\_location\_based\_ghg} field in the NYC Local Law 84 dataset\footnote{NYC Open Data API: https://data.cityofnewyork.us/resource/5zyy-y8am.json using \code{total\_location\_based\_ghg} field. This field contains the total GHG emissions in metric tons CO2e calculated using location-based emissions factors.}:

\begin{align}
\code{totalBuildingEmissionsLL84} &= \text{LL84}[\text{total\_location\_based\_ghg}]
\end{align}

The property use breakdown is obtained from the \code{list\_of\_all\_property\_use} field, which contains a comma-separated string of property types with their corresponding square footage. For example: ``Office (264550.0), Retail Store (21700.0), Parking (13000.0)''. This string is parsed to extract individual property use types and their associated square footage for emissions budget calculations.

The emissions budget for the building is calculated as the sum of type-specific emissions limits applied to corresponding square footage\footnote{Key LL97 property type limits (tCO2e/sf) across four compliance periods: Office (2024-29: 0.00846, 2030-34: 0.00453, 2035-39: 0.00165234, 2040-49: 0.000581893), Multifamily Housing (2024-29: 0.00892, 2030-34: 0.00453), Hospital (2024-29: 0.02551, 2030-34: 0.01542). Complete mapping available in ll97\_espm\_to\_bc\_caps\_with\_2035\_2049.json.}:

\begin{align}
\code{emissionsBudget} &= \sum_{i} \code{squareFootageByType}_i \times \code{emissionsLimit}_i
\end{align}

\subsection{Annual Fee Calculation with BE Credit Integration}

LL97 has four compliance periods with different emissions budgets. For buildings implementing PTHP upgrades, the annual fee calculation includes Beneficial Electrification (BE) credits that reduce penalties. The calculation process follows these steps for each period:

1. Calculate base emissions budget for the period
2. Determine adjusted building emissions after retrofit
3. Calculate BE credits (if applicable)
4. Apply BE credits to reduce adjusted emissions
5. Calculate final annual fee based on credited emissions

\subsubsection{Base Emissions Budgets by Period}

\textbf{2024-2029 Compliance Period}
\begin{align}
\code{emissionsBudget2024to2029} &= \sum_{i} \code{squareFootageByType}_i \times \code{emissionsLimit2024to2029}_i
\end{align}

\textbf{2030-2034 Compliance Period}
\begin{align}
\code{emissionsBudget2030to2034} &= \sum_{i} \code{squareFootageByType}_i \times \code{emissionsLimit2030to2034}_i
\end{align}

\textbf{2035-2039 Compliance Period}
\begin{align}
\code{emissionsBudget2035to2039} &= \sum_{i} \code{squareFootageByType}_i \times \code{emissionsLimit2035to2039}_i
\end{align}

\textbf{2040-2049 Compliance Period}
\begin{align}
\code{emissionsBudget2040to2049} &= \sum_{i} \code{squareFootageByType}_i \times \code{emissionsLimit2040to2049}_i
\end{align}

Where \code{feePerTonCO2e} = \$268 per tCO2e over budget, and each subsequent period has more stringent (lower) emissions limits.

\subsubsection{Adjusted Building Emissions After Retrofit}

To accurately assess the LL97 fee impact of the PTAC→PTHP retrofit, we must calculate the building's adjusted emissions that reflect the actual post-retrofit energy consumption and emissions profile, rather than using the baseline LL84 emissions\footnote{Using raw LL84 emissions would not account for the actual emissions reduction from switching from gas heating to electric heat pumps, which varies by time period due to changing grid electricity emissions factors.}.

The adjusted building emissions are calculated as:

\begin{align}
\code{adjustedTotalBuildingEmissions} &= \code{totalBuildingEmissionsLL84} \nonumber \\
&\quad - (\code{annualBuildingMMBtuHeatingPTAC} \times \code{efGas}) \nonumber \\
&\quad + (\code{annualBuildingKwhHeatingPTHP} \times \code{efGrid\_kWh(year)})
\end{align}

Where the emissions factors are:
\begin{itemize}
    \item \code{efGas}: 0.05311 tCO₂e/MMBtu (natural gas factor, constant 2024-2034)
    \item \code{efGrid\_kWh(year)}: Grid electricity factor (tCO₂e/kWh) varying by compliance period:
    \begin{itemize}
        \item \code{efGrid2024to2029}: 0.000288962 tCO₂e/kWh
        \item \code{efGrid2030to2034}: 0.000145 tCO₂e/kWh
        \item \code{efGrid2035toFuture}: 0.000145 tCO₂e/kWh (assumed same as 2030-2034, pending further research\footnote{The grid electricity emissions factor for periods beyond 2034 requires additional research to determine accurate projections based on grid decarbonization plans and renewable energy adoption rates.})
    \end{itemize}
\end{itemize}

This gives us period-specific adjusted emissions:

\begin{align}
\code{adjustedTotalBuildingEmissions2024to2029} &= \code{totalBuildingEmissionsLL84} \nonumber \\
&\quad - (\code{annualBuildingMMBtuHeatingPTAC} \times 0.05311) \nonumber \\
&\quad + (\code{annualBuildingKwhHeatingPTHP} \times 0.000288962)
\end{align}

\begin{align}
\code{adjustedTotalBuildingEmissions2030to2034} &= \code{totalBuildingEmissionsLL84} \nonumber \\
&\quad - (\code{annualBuildingMMBtuHeatingPTAC} \times 0.05311) \nonumber \\
&\quad + (\code{annualBuildingKwhHeatingPTHP} \times 0.000145)
\end{align}

\begin{align}
\code{adjustedTotalBuildingEmissions2035to2039} &= \code{totalBuildingEmissionsLL84} \nonumber \\
&\quad - (\code{annualBuildingMMBtuHeatingPTAC} \times 0.05311) \nonumber \\
&\quad + (\code{annualBuildingKwhHeatingPTHP} \times \code{efGrid2035toFuture})
\end{align}

\begin{align}
\code{adjustedTotalBuildingEmissions2040to2049} &= \code{totalBuildingEmissionsLL84} \nonumber \\
&\quad - (\code{annualBuildingMMBtuHeatingPTAC} \times 0.05311) \nonumber \\
&\quad + (\code{annualBuildingKwhHeatingPTHP} \times \code{efGrid2035toFuture})
\end{align}

\subsubsection{Beneficial Electrification (BE) Credit Calculation}

The BE credit is calculated based on heating electrification only, using annual heating kWh and time-dependent coefficients:

\begin{align}
\code{beCreditBefore2027} &= \code{annualBuildingkWhHeatingPTHP} \times 0.0013
\end{align}

\begin{align}
\code{beCredit2027to2029} &= \code{annualBuildingkWhHeatingPTHP} \times 0.00065
\end{align}

Where:
\begin{itemize}
    \item Before January 1, 2027: Coefficient = 0.0013 tCO₂e/kWh
    \item 2027-2029: Coefficient = 0.00065 tCO₂e/kWh
\end{itemize}

\subsubsection{Final Annual Fee Calculation with BE Credits}

\textbf{Annual Fee for 2024-2026 (with BE Credit)}

For buildings upgrading before January 1, 2027:

\begin{align}
\code{creditedEmissionsBefore2027} &= \code{adjustedTotalBuildingEmissions2024to2029} - \code{beCreditBefore2027}
\end{align}

\begin{align}
\code{adjustedAnnualFeeBefore2027} &= (\code{creditedEmissionsBefore2027} \nonumber\\
&\quad - \code{emissionsBudget2024to2029}) \times \code{feePerTonCO2e}
\end{align}

\textbf{Annual Fee for 2027-2029 (with Reduced BE Credit)}

For buildings upgrading between 2027-2029:

\begin{align}
\code{creditedEmissions2027to2029} &= \code{adjustedTotalBuildingEmissions2024to2029} - \code{beCredit2027to2029}
\end{align}

\begin{align}
\code{adjustedAnnualFee2027to2029} &= (\code{creditedEmissions2027to2029} \nonumber\\
&\quad - \code{emissionsBudget2024to2029}) \times \code{feePerTonCO2e}
\end{align}

\textbf{Annual Fee for 2030-2034 (No BE Credit)}

For the 2030-2034 period, there is no BE credit available, so the fee is calculated using the adjusted emissions for this period:

\begin{align}
\code{adjustedAnnualFee2030to2034} &= (\code{adjustedTotalBuildingEmissions2030to2034} \nonumber\\
&\quad - \code{emissionsBudget2030to2034}) \times \code{feePerTonCO2e}
\end{align}

\textbf{Annual Fee for 2035-2039 (No BE Credit)}

For the 2035-2039 period, there is no BE credit available, so the fee is calculated using the adjusted emissions for this period:

\begin{align}
\code{adjustedAnnualFee2035to2039} &= (\code{adjustedTotalBuildingEmissions2035to2039} \nonumber\\
&\quad - \code{emissionsBudget2035to2039}) \times \code{feePerTonCO2e}
\end{align}

\textbf{Annual Fee for 2040-2049 (No BE Credit)}

For the 2040-2049 period, there is no BE credit available, so the fee is calculated using the adjusted emissions for this period:

\begin{align}
\code{adjustedAnnualFee2040to2049} &= (\code{adjustedTotalBuildingEmissions2040to2049} \nonumber\\
&\quad - \code{emissionsBudget2040to2049}) \times \code{feePerTonCO2e}
\end{align}

For both periods, we use the \code{efGrid2035toFuture} emissions factor as defined above.

\subsubsection{Baseline Annual Fees (No Upgrade)}

For comparison, the baseline annual fees without any retrofit are calculated using the original LL84 emissions:

\begin{align}
\code{annualFeeExceedingBudget2024to2029} &= (\code{totalBuildingEmissionsLL84} \nonumber\\
&\quad - \code{emissionsBudget2024to2029}) \times \code{feePerTonCO2e}
\end{align}

\begin{align}
\code{annualFeeExceedingBudget2030to2034} &= (\code{totalBuildingEmissionsLL84} \nonumber\\
&\quad - \code{emissionsBudget2030to2034}) \times \code{feePerTonCO2e}
\end{align}

\begin{align}
\code{annualFeeExceedingBudget2035to2039} &= (\code{totalBuildingEmissionsLL84} \nonumber\\
&\quad - \code{emissionsBudget2035to2039}) \times \code{feePerTonCO2e}
\end{align}

\begin{align}
\code{annualFeeExceedingBudget2040to2049} &= (\code{totalBuildingEmissionsLL84} \nonumber\\
&\quad - \code{emissionsBudget2040to2049}) \times \code{feePerTonCO2e}
\end{align}


\section{Financial Analysis of PTHP Upgrade}

\vspace{0.3cm}
\noindent\fbox{%
\parbox{\dimexpr\linewidth-2\fboxsep-2\fboxrule}%
{\textbf{Timing Configuration:} The financial analysis now supports configurable loan start year (default: 2025). Energy savings begin the year after loan origination (default: 2026). LL97 fee avoidance calculations only apply from 2026 onwards, regardless of loan start year.}%
}
\vspace{0.3cm}

In order to calculate the financial viability of upgrading from PTAC to PTHP systems, we first need to calculate how much money you will be saving each year from the time you upgrade. This annual savings is composed of two main components: the energy savings (\code{annualSavingsEnergy} from Section 7) and the LL97 fee avoidance. The following 4 subsections show how calculating this varies depending on which period you are in, noting that LL97 compliance continues post-2035 with ongoing fee avoidance benefits.

\subsection{LL97 Fee Avoidance Calculations}

\subsubsection{LL97 Fee Avoidance for 2024-2027}

\begin{align}
\code{annualLL97FeeAvoidance2024to2027} &= \code{annualFeeExceedingBudget2024to2029} \nonumber\\
&\quad - \code{adjustedAnnualFeeBefore2027}
\end{align}

\subsubsection{LL97 Fee Avoidance for 2027-2029}

\begin{align}
\code{annualLL97FeeAvoidance2027to2029} &= \code{annualFeeExceedingBudget2024to2029} \nonumber \\
&\quad - \code{adjustedAnnualFee2027to2029}
\end{align}

\subsubsection{LL97 Fee Avoidance for 2030-2034}

\begin{align}
\code{annualLL97FeeAvoidance2030to2034} &= \code{annualFeeExceedingBudget2030to2034} \nonumber \\
&\quad - \code{adjustedAnnualFee2030to2034}
\end{align}

\subsubsection{LL97 Fee Avoidance for 2035-2039}

\begin{align}
\code{annualLL97FeeAvoidance2035to2039} &= \code{annualFeeExceedingBudget2035to2039} \nonumber \\
&\quad - \code{adjustedAnnualFee2035to2039}
\end{align}

\subsubsection{LL97 Fee Avoidance for 2040-2049}

\begin{align}
\code{annualLL97FeeAvoidance2040to2049} &= \code{annualFeeExceedingBudget2040to2049} \nonumber \\
&\quad - \code{adjustedAnnualFee2040to2049}
\end{align}

\newpage
\subsection{Code Implementation}

This is the implementation for calculating cumulative savings:

\bigskip

Code Chunk 1: Function to calculate annual savings in a given year
\begin{lstlisting}
function getAnnualSavings(year: number): number {
  const energySavings = annualSavingsEnergy;
  
  // LL97 penalties only apply from 2026 onwards
  if (year >= 2026 && year <= 2026) {
    return energySavings + annualLL97FeeAvoidance2024to2027;
  } else if (year >= 2027 && year <= 2029) {
    return energySavings + annualLL97FeeAvoidance2027to2029;
  } else if (year >= 2030 && year <= 2034) {
    return energySavings + annualLL97FeeAvoidance2030to2034;
  } else if (year >= 2035 && year <= 2039) {
    return energySavings + annualLL97FeeAvoidance2035to2039;
  } else if (year >= 2040) {
    return energySavings + annualLL97FeeAvoidance2040to2049;
  } else {
    return energySavings; // Only energy savings before 2026
  }
}
\end{lstlisting}

Code Chunk 2: Example usage of calculating annual savings
\begin{lstlisting}
// Loan term years for a static example - loan starts in 2025 (configurable), savings start in 2026
const loanStartYear = 2025; // Configurable loan start year
const savingsStartYear = loanStartYear + 1; // Savings start year after loan origination
const loanYears = [2025, 2026, 2027, 2028, 2029, 2030, 2031, 2032, 2033, 2034, 2035, 2036, 2037, 2038, 2039, 2040];
const cumulativeSavingsByYear = [];
let cumulativeSavings = 0;

for (const year of loanYears) {
  // No savings during loan start year, savings begin in savingsStartYear
  const annualSavings = year < savingsStartYear ? 0 : getAnnualSavings(year);
  cumulativeSavings += annualSavings;
  
  cumulativeSavingsByYear.push(cumulativeSavings);
}

// This array will be the data for the green cumulative savings line in the visualization
console.log(cumulativeSavingsByYear);

// Actual output: [0, 47000, 94000, 138000, 182000, 226000, 267000, 308000, 349000, 390000, 431000, 468000, 505000, 542000, 579000, 616000]
\end{lstlisting}

From the array of cumulative savings year-by-year, once it gets above the totalRetrofitCost, then that year is the Simple Payback Period.\footnote{Simple division (totalRetrofitCost ÷ averageAnnualSavings) cannot be used here because annual savings vary significantly across LL97 compliance periods. The year-by-year calculation accounts for these varying savings rates.}

\subsection{Payback Period Implementation}

For \code{totalRetrofitCost} = \$500,000, the cumulative savings array shows:

[0, 47000, 94000, 138000, 182000, 226000, 267000, 308000, 349000, 390000, 431000, 468000, \textbf{505000}, 542000, 579000, 616000]

\textbf{Year 2037} achieves payback with \$505,000 cumulative savings.

\section{Loan Financing and Payback Visualization}

This section demonstrates how loan financing affects the payback period through a visual representation of loan balance versus cumulative savings over time.

\subsection{Loan Parameters}

For this example, we use typical commercial loan parameters\footnote{Example parameters: Principal = \$500,000 (\code{totalRetrofitCost}), Term = 15 years, Annual interest rate = 6\%, Monthly interest rate = 0.005, Total payments = 180.}:

The loan calculations use standard amortization formulas\footnote{Monthly payment: $P \times \frac{r(1+r)^n}{(1+r)^n-1}$ where P=principal, r=monthly rate, n=total payments.} and the remaining balance formula\footnote{Remaining balance: $P \times \frac{(1+r)^n-(1+r)^{mt}}{(1+r)^n-1}$ where t=years elapsed, m=12 months/year.}. 

Cumulative savings grow linearly over time\footnote{Simplified as: $\text{Cumulative Savings}(t) = t \times \text{Average Annual Savings}$. In reality, LL97 fee avoidance varies by compliance period.}:

\subsection{Visualization}

\begin{center}
\begin{tikzpicture}
\begin{axis}[
    title={\textbf{Loan Balance vs. Cumulative Savings}},
    xlabel={Year},
    ylabel={Amount},
    xmin=2025, xmax=2042,
    ymin=0, ymax=700000,
    legend pos=north east,
    grid=major,
    grid style={line width=0.1pt, draw=gray!30},
    major grid style={line width=0.2pt, draw=gray!50},
    width=14cm,
    height=10cm,
    axis background/.style={fill=gray!5},
    scaled y ticks=false,
    y tick label style={/pgf/number format/fixed,/pgf/number format/1000 sep=\,},
    yticklabel={\$\pgfmathprintnumber{\tick}},
    xtick={2025,2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040,2041,2042},
    x tick label style={rotate=90, anchor=east, /pgf/number format/fixed,/pgf/number format/1000 sep=},
    xticklabels={\textbf{2025},2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040,2041,2042}
]

% Realistic loan balance with proper amortization curve
\addplot[color=blue!70!black, line width=2pt, smooth] coordinates {
    (2025, 500000) (2026, 485500) (2027, 470200) (2028, 454000) (2029, 436800)
    (2030, 418500) (2031, 399000) (2032, 378200) (2033, 355900) (2034, 332000)
    (2035, 306300) (2036, 278700) (2037, 248900) (2038, 216800) (2039, 182200) (2040, 144800) (2041, 104400) (2042, 0)
};

% Cumulative savings - no savings in 2025 (upgrade year), savings begin in 2026
\addplot[color=green!60!black, line width=2pt, smooth] coordinates {
    (2025, 0) (2026, 0) (2027, 47000) (2028, 94000) (2029, 138000) (2030, 182000)
    (2031, 226000) (2032, 267000) (2033, 308000) (2034, 349000) (2035, 390000)
    (2036, 431000) (2037, 468000) (2038, 505000) (2039, 542000) (2040, 579000) (2041, 616000) (2042, 653000)
};

% Add marker at payback point
\addplot[only marks, mark=*, mark size=4pt, color=red] coordinates {(2038, 505000)};

% Add professional annotation with arrow
\node[anchor=south east, align=center, font=\small\sffamily] at (axis cs:2036,500000) {
    \textcolor{black}{\textsc{Simple Payback}}\\
    \textcolor{black}{\textsc{Period Reached}}
};
\draw[->, color=black, line width=1pt] (axis cs:2036.2,502000) -- (axis cs:2037.95,505000);

% Upgrade completion vertical line and label
\draw[color=blue, line width=2pt, dashed] (axis cs:2025,0) -- (axis cs:2025,700000);
\node[anchor=south, font=\scriptsize\sffamily, rotate=90, color=blue] at (axis cs:2025,650000) {Upgrade Completed};

\legend{Remaining Loan Balance, Cumulative Savings}

\end{axis}
\end{tikzpicture}
\end{center}

The simple payback period occurs when the green cumulative savings line reaches the loan principal amount of \$500,000. This visualization shows how cumulative savings continue to grow beyond payback, demonstrating the long-term financial benefits of the retrofit investment.

\section{NOI Analysis}

Net Operating Income (NOI) represents the annual income generated by a property after deducting all operating expenses but before deducting taxes and debt service. The methodology uses a unified approach based on rent stabilization status and building characteristics from PLUTO data.

\subsection{NOI Calculation Methodology}

The system uses a three-step process to calculate annual building NOI:

\subsubsection{Step 1: NOI Calculation}

The system uses a three-tier approach based on building class:

\textbf{Cooperative Buildings (Building Classes C0-C9)}

NOI values are obtained directly from the NYC Open Data Cooperative Comparable Rental Income dataset\footnote{NYC Open Data API: https://data.cityofnewyork.us/resource/myei-c3fa.json using \code{net\_operating\_income} field. Data updated periodically by NYC Department of Finance.}:

\begin{equation}
\code{currentNOI} = \text{API}(\text{BBL})[\text{net\_operating\_income}]
\end{equation}

\textbf{Condominium Buildings (Building Classes R4, R5, R6A-R9B, D4-D9)}

NOI values are obtained directly from the NYC Open Data Condominium Comparable Rental Income dataset\footnote{NYC Open Data API: https://data.cityofnewyork.us/resource/9ck6-2jew.json using \code{net\_operating\_income} field. Data updated periodically by NYC Department of Finance.}:

\begin{equation}
\code{currentNOI} = \text{API}(\text{BBL})[\text{net\_operating\_income}]
\end{equation}

\textbf{All Other Residential Buildings (Fallback)}

For buildings not covered by NYC Open Data APIs or where data is not available, NOI is calculated using the 2025 RGB Study data\footnote{Source: \textit{2025 Income and Expense Study}, NYC Rent Guidelines Board, March 2025. Data structured by tenure (stabilized/market rate), location, building age, and size buckets.}. To use this data, we need to determine rent stabilization status and location:

\subsubsection{Step 2: Rent Stabilization Determination}

Determine if the building contains rent stabilized units:

\begin{lstlisting}
function isRentStabilized(bbl: string, pluto: PlutoRecord): boolean {
  // Primary Method: BBL lookup in rent stabilized buildings registry
  if (rentStabilizedBBLs.includes(bbl)) {
    return true;
  }
  
  // Fallback Heuristic: PLUTO-based criteria
  const isPrewar = pluto.yearBuilt > 0 && pluto.yearBuilt < 1974;
  const isHighRise = pluto.numFloors > 6;
  const isNotCondo = pluto.condoNo == null;
  const isNotCoop = !pluto.bldgClass.includes("C6") && !pluto.bldgClass.includes("D4");
  
  return isPrewar && isHighRise && isNotCondo && isNotCoop;
}
\end{lstlisting}

\subsubsection{Step 3: Location Assignment}

Determine the building's location category based on borough and community district (Core Manhattan: CD 101-108; Upper Manhattan: CD 109-112).

\subsubsection{Step 4: Final NOI Calculation}

The NOI per unit per month is obtained from the 2025 RGB Study data using location, rent stabilization status, building era (for stabilized buildings), and size buckets (11-19 units, 20-99 units, 100+ units). Era is determined by: \code{yearBuilt} $\leq$ 1973 $\rightarrow$ \code{pre\_1974}, otherwise \code{post\_1973}. Market rate data is not segmented by building era.

For all buildings, the final annual building NOI is calculated as:

\begin{equation}
\code{annualBuildingNOI} = \code{noiPerUnitPerMonth} \times \code{unitsRes} \times 12
\end{equation}

Where:
\begin{itemize}
    \item \code{noiPerUnitPerMonth}: NOI per residential unit per month from lookup
    \item \code{unitsRes}: Total residential units in building
    \item 12: Months per year conversion factor
\end{itemize}

\subsection{Upgrade Impact on NOI}

The true impact of PTHP upgrades becomes clear when comparing NOI scenarios:

\textbf{Scenario A: No Upgrade (Status Quo)}
\begin{align}
\code{noiNoUpgrade2024to2029} &= \code{currentNOI} - \code{annualFeeExceedingBudget2024to2029}
\end{align}
\begin{align}
\code{noiNoUpgrade2030to2034} &= \code{currentNOI} - \code{annualFeeExceedingBudget2030to2034}
\end{align}
\begin{align}
\code{noiNoUpgradePost2035} &= \code{currentNOI} - \code{annualFeeExceedingBudget2035to2039}
\end{align}

\textbf{Scenario B: With PTHP Upgrade}
\begin{align}
\code{noiWithUpgrade2024to2027} &= \code{currentNOI} + \code{annualSavingsEnergy} \nonumber\\
&\quad - \code{adjustedAnnualFee2024to2027}
\end{align}
\begin{align}
\code{noiWithUpgrade2027to2029} &= \code{currentNOI} + \code{annualSavingsEnergy} \nonumber\\
&\quad - \code{adjustedAnnualFee2027to2029}
\end{align}
\begin{align}
\code{noiWithUpgrade2030to2034} &= \code{currentNOI} + \code{annualSavingsEnergy} \nonumber\\
&\quad - \code{adjustedAnnualFee2030to2034}
\end{align}
\begin{align}
\code{noiWithUpgradePost2035} &= \code{currentNOI} + \code{annualSavingsEnergy} \nonumber\\
&\quad - \code{adjustedAnnualFee2035to2039}
\end{align}

\subsection{NOI Calculation Functions}

The NOI calculations can be implemented with unified functions that handle all compliance periods:

\begin{lstlisting}
function calculateAdjustedNOINoUpgrade(year: number): number {
  const currentNOI = await getNoiByBbl(bbl, unitBreakdown); // from NOI API endpoint
  
  if (year >= 2024 && year <= 2029) {
    return currentNOI - annualFeeExceedingBudget2024to2029;
  } else if (year >= 2030 && year <= 2034) {
    return currentNOI - annualFeeExceedingBudget2030to2034;
  } else if (year >= 2035 && year <= 2039) {
    return currentNOI - annualFeeExceedingBudget2035to2039;
  } else {
    return currentNOI - annualFeeExceedingBudget2040to2049;
  }
}

function calculateAdjustedNOIUpgrade(year: number): number {
  const currentNOI = await getNoiByBbl(bbl, unitBreakdown); // from NOI API endpoint
  const energySavings = getEnergySavings();
  
  let reducedLL97Penalties = 0;
  if (year >= 2024 && year <= 2029) {
    reducedLL97Penalties = adjustedAnnualFee2024to2029; // actual penalties paid after upgrade
  } else if (year >= 2030 && year <= 2034) {
    reducedLL97Penalties = adjustedAnnualFee2030to2034; // actual penalties paid after upgrade  
  } else if (year >= 2035 && year <= 2039) {
    reducedLL97Penalties = adjustedAnnualFee2035to2039; // actual penalties paid after upgrade
  } else {
    reducedLL97Penalties = adjustedAnnualFee2040to2049; // actual penalties paid after upgrade
  }
  
  return currentNOI + energySavings - reducedLL97Penalties;
}
\end{lstlisting}

\subsubsection{Implementation Example}

For a 100,000 sq ft rental building with current NOI of \$1,200,000:

\textbf{Without Upgrade:} Building faces ongoing LL97 penalties starting in 2026
\begin{itemize}
    \item 2024-2025: NOI = \$1,200,000 (current NOI) - \$0 (no penalties yet) = \$1,200,000
    \item 2026-2029: NOI = \$1,200,000 (current NOI) - \$150,000 (LL97 penalties paid) = \$1,050,000
    \item 2030-2034: NOI = \$1,200,000 (current NOI) - \$300,000 (LL97 penalties paid) = \$900,000
    \item 2035+: NOI = \$1,200,000 (current NOI) - \$300,000 (LL97 penalties paid) = \$900,000
\end{itemize}

\textbf{With PTHP Upgrade:} Upgrade completes in 2025, savings + reduced penalties start in 2026
\begin{itemize}
    \item 2024-2025: NOI = \$1,200,000 (current NOI) - \$0 (no changes yet) = \$1,200,000
    \item 2026-2027: NOI = \$1,200,000 (current NOI) + \$39,000 (energy savings) - \$15,000 (reduced LL97 penalties) = \$1,224,000
    \item 2030-2034: NOI = \$1,200,000 (current NOI) + \$39,000 (energy savings) - \$33,000 (reduced LL97 penalties) = \$1,206,000  
    \item 2035+: NOI = \$1,200,000 (current NOI) + \$39,000 (energy savings) - \$33,000 (reduced LL97 penalties) = \$1,206,000
\end{itemize}

\subsection{NOI Visualization Over Time}

The following chart shows how NOI evolves differently in upgrade vs no-upgrade scenarios across LL97 compliance periods:

\begin{center}
\begin{tikzpicture}
\begin{axis}[
    title={\textbf{Adjusted NOI by Scenario}},
    xlabel={Year},
    ylabel={Annual NOI (\$1000s)},
    xmin=2024, xmax=2040,
    ymin=800, ymax=1600,
    legend pos=south east,
    legend style={draw=black, fill=white, fill opacity=0.8, text opacity=1},
    grid=major,
    grid style={line width=0.1pt, draw=gray!30},
    major grid style={line width=0.2pt, draw=gray!50},
    width=14cm,
    height=10cm,
    axis background/.style={fill=gray!5},
    scaled y ticks=false,
    y tick label style={/pgf/number format/fixed,/pgf/number format/1000 sep=\,},
    yticklabel={\$\pgfmathprintnumber{\tick}K},
    xtick={2024,2025,2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040},
    x tick label style={rotate=90, anchor=east, /pgf/number format/fixed,/pgf/number format/1000 sep=},
    xticklabels={2024,\textbf{2025},2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040}
]

% NOI with PTHP upgrade - upgrade completes in 2025, savings start in 2026
\addplot[color=green!60!black, line width=3pt, smooth] coordinates {
    (2024, 1200) (2025, 1200) (2026, 1224) (2027, 1224) (2028, 1224) (2029, 1224)
    (2030, 1206) (2031, 1206) (2032, 1206) (2033, 1206) (2034, 1206)
    (2035, 1206) (2036, 1206) (2037, 1206) (2038, 1206) (2039, 1206) (2040, 1206)
};

% NOI without upgrade - dramatic drop in 2026 when LL97 fees kick in
\addplot[color=red!70!black, line width=3pt, smooth] coordinates {
    (2024, 1200) (2025, 1200) (2026, 1050) (2027, 1050) (2028, 1050) (2029, 1050)
    (2030, 900) (2031, 900) (2032, 900) (2033, 900) (2034, 900)
    (2035, 900) (2036, 900) (2037, 900) (2038, 900) (2039, 900) (2040, 900)
};

% Add period markers
\draw[color=blue, line width=2pt, dashed] (axis cs:2025,800) -- (axis cs:2025,1600);
\draw[color=orange, line width=1.5pt, dashed] (axis cs:2027,800) -- (axis cs:2027,1600);
\draw[color=orange, line width=1.5pt, dashed] (axis cs:2030,800) -- (axis cs:2030,1600);
\draw[color=orange, line width=1.5pt, dashed] (axis cs:2035,800) -- (axis cs:2035,1600);

% Upgrade completion label
\node[anchor=south, font=\scriptsize\sffamily, rotate=90, color=blue] at (axis cs:2025,1500) {Upgrade Completed};

% Period labels
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2026.5,1400) {Fees/Savings Begin};
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2028.5,1400) {Reduced BE Credit};
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2032,1400) {Higher LL97 Penalties};
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2037.5,1400) {Continued LL97};

% Highlight the NOI gap in critical period and beyond
\fill[yellow!30, opacity=0.5] (axis cs:2030,900) rectangle (axis cs:2040,1206);
\node[anchor=center, font=\small\sffamily, color=black] at (axis cs:2035,1053) {\textbf{Sustained NOI Gap}};
\node[anchor=center, font=\small\sffamily, color=black] at (axis cs:2035,1000) {\textbf{\$306K/year}};

\legend{NOI with PTHP Upgrade, NOI without Upgrade}

\end{axis}
\end{tikzpicture}
\end{center}

This NOI comparison reveals the true financial impact of upgrade timing:
\begin{itemize}
    \item \textbf{Immediate NOI Boost}: Upgrading in 2024 increases NOI by \$174K/year (17\% increase)
    \item \textbf{Penalty Avoidance}: Without upgrade, NOI drops \$150K in 2030+ due to higher penalties  
    \item \textbf{Perpetual Benefit}: The \$306K annual NOI gap continues indefinitely post-2035, creating sustained property value advantages
    \item \textbf{Risk Mitigation}: Upgrading protects against declining property values from ongoing LL97 penalties
    \item \textbf{Optimal Window}: Early upgrade (2024-2027) captures maximum BE Credit and avoids penalty escalation
    \item \textbf{Long-term Value}: LL97 compliance continues post-2035, making upgrade benefits permanent rather than temporary
\end{itemize}

\section{Property Value Analysis}

Property values are calculated by dividing NOI by the cap rate, providing a direct correlation between operational performance improvements and asset valuation.

\subsection{Property Value Calculation Functions}

Property value calculations use the same scenarios as NOI but apply cap rate conversion:

\begin{lstlisting}
function calculatePropertyValueNoUpgrade(year: number, capRate: number = 0.04): number {
  const adjustedNOI = calculateAdjustedNOINoUpgrade(year); // NOI minus actual LL97 penalties paid
  return adjustedNOI / capRate;
}

function calculatePropertyValueUpgrade(year: number, capRate: number = 0.04): number {
  const adjustedNOI = calculateAdjustedNOIUpgrade(year); // NOI plus energy savings minus reduced LL97 penalties
  return adjustedNOI / capRate;
}
\end{lstlisting}

The default cap rate of 4\% reflects typical NYC multifamily properties\footnote{Cap rate of 4\% used for NYC multifamily properties. This parameter can be adjusted based on market conditions, property characteristics, and investment criteria.}.

\subsection{Property Value Impact Analysis}

Using a 4\% cap rate typical for NYC multifamily properties:

\textbf{No Upgrade Property Values}
\begin{align}
\code{propertyValueNoUpgrade} &= \code{noiNoUpgrade} \div 0.04
\end{align}

\textbf{With Upgrade Property Values}  
\begin{align}
\code{propertyValueWithUpgrade} &= \code{noiWithUpgrade} \div 0.04
\end{align}

\textbf{Net Property Value Impact}
\begin{align}
\code{netPropertyValueGain} &= \code{propertyValueWithUpgrade} - \code{propertyValueNoUpgrade}
\end{align}

\subsubsection{Implementation Example}

For a 100,000 sq ft rental building with current NOI of \$1,200,000:

\textbf{Without Upgrade:} Building faces ongoing LL97 penalties starting in 2026
\begin{itemize}
    \item 2024-2025: Property Value = \$1,200,000 (NOI) ÷ 0.04 (cap rate) = \$30.0M
    \item 2026-2029: Property Value = \$1,050,000 (NOI) ÷ 0.04 (cap rate) = \$26.25M
    \item 2030-2034: Property Value = \$900,000 (NOI) ÷ 0.04 (cap rate) = \$22.5M
    \item 2035+: Property Value = \$900,000 (NOI) ÷ 0.04 (cap rate) = \$22.5M
\end{itemize}

\textbf{With PTHP Upgrade:} Upgrade completes in 2025, value increases in 2026
\begin{itemize}
    \item 2024-2025: Property Value = \$1,200,000 (NOI) ÷ 0.04 (cap rate) = \$30.0M
    \item 2026-2027: Property Value = \$1,224,000 (NOI) ÷ 0.04 (cap rate) = \$30.6M
    \item 2030-2034: Property Value = \$1,206,000 (NOI) ÷ 0.04 (cap rate) = \$30.15M  
    \item 2035+: Property Value = \$1,206,000 (NOI) ÷ 0.04 (cap rate) = \$30.15M
\end{itemize}

\textbf{Net Property Value Gain:} \$30.15M - \$22.5M = \$7.65M

This \$7.65M property value increase far exceeds typical retrofit costs of \$500K-\$2M, demonstrating the compelling financial case for upgrading.

\subsection{Property Value Impact Visualization}

The following chart demonstrates property value trajectories for both scenarios:

\begin{center}
\begin{tikzpicture}
\begin{axis}[
    title={\textbf{Property Value by Scenario}},
    xlabel={Year},
    ylabel={Property Value (\$Millions)},
    xmin=2024, xmax=2040,
    ymin=20, ymax=40,
    legend pos=south east,
    legend style={draw=black, fill=white, fill opacity=0.8, text opacity=1},
    grid=major,
    grid style={line width=0.1pt, draw=gray!30},
    major grid style={line width=0.2pt, draw=gray!50},
    width=14cm,
    height=10cm,
    axis background/.style={fill=gray!5},
    scaled y ticks=false,
    y tick label style={/pgf/number format/fixed,/pgf/number format/1000 sep=\,},
    yticklabel={\$\pgfmathprintnumber{\tick}M},
    xtick={2024,2025,2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040},
    x tick label style={rotate=90, anchor=east, /pgf/number format/fixed,/pgf/number format/1000 sep=},
    xticklabels={2024,\textbf{2025},2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040}
]

% Property value with PTHP upgrade - upgrade completes in 2025, value increases in 2026
\addplot[color=green!60!black, line width=3pt, smooth] coordinates {
    (2024, 30.0) (2025, 30.0) (2026, 30.6) (2027, 30.6) (2028, 30.6) (2029, 30.6)
    (2030, 30.15) (2031, 30.15) (2032, 30.15) (2033, 30.15) (2034, 30.15)
    (2035, 30.15) (2036, 30.15) (2037, 30.15) (2038, 30.15) (2039, 30.15) (2040, 30.15)
};

% Property value without upgrade - dramatic drop in 2026 when LL97 fees kick in
\addplot[color=red!70!black, line width=3pt, smooth] coordinates {
    (2024, 30.0) (2025, 30.0) (2026, 26.25) (2027, 26.25) (2028, 26.25) (2029, 26.25)
    (2030, 22.5) (2031, 22.5) (2032, 22.5) (2033, 22.5) (2034, 22.5)
    (2035, 22.5) (2036, 22.5) (2037, 22.5) (2038, 22.5) (2039, 22.5) (2040, 22.5)
};

% Period markers
\draw[color=blue, line width=2pt, dashed] (axis cs:2025,20) -- (axis cs:2025,40);
\draw[color=orange, line width=1.5pt, dashed] (axis cs:2027,20) -- (axis cs:2027,40);
\draw[color=orange, line width=1.5pt, dashed] (axis cs:2030,20) -- (axis cs:2030,40);
\draw[color=orange, line width=1.5pt, dashed] (axis cs:2035,20) -- (axis cs:2035,40);

% Upgrade completion label
\node[anchor=south, font=\scriptsize\sffamily, rotate=90, color=blue] at (axis cs:2025,37) {Upgrade Completed};

% Period labels
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2026.5,35) {Fees/Savings Begin};
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2028.5,35) {Reduced BE Credit};
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2032,35) {Higher LL97 Penalties};
\node[anchor=south, font=\scriptsize\sffamily, rotate=90] at (axis cs:2037.5,35) {Continued LL97};

% Highlight the value gap
\fill[yellow!30, opacity=0.5] (axis cs:2030,22.5) rectangle (axis cs:2040,30.15);
\node[anchor=center, font=\small\sffamily, color=black] at (axis cs:2035,26.325) {\textbf{Property Value Gap}};
\node[anchor=center, font=\small\sffamily, color=black] at (axis cs:2035,24.75) {\textbf{\$7.65M}};

\legend{Property Value with Upgrade, Property Value without Upgrade}

\end{axis}
\end{tikzpicture}
\end{center}

This visualization demonstrates the substantial and sustained property value advantage of upgrading, with the \$7.65M gap representing the permanent value creation from PTHP installation.

\section{Implementation Notes}

All variables in the codebase follow camelCase naming convention with the appropriate PTAC or PTHP suffix for clarity. The calculations are implemented in the backend services using TypeScript, ensuring type safety and consistent naming across the platform.

\end{document}